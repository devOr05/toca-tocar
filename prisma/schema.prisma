// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  role           String          @default("USER") // USER, ADMIN
  participations Participation[]
  hostedJams     Jam[]
  messages       Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Profile Fields
  mainInstrument String?
  city           String?
  favoriteTheme  String?
  hasRecorded    String?

  // Social Links
  instagram  String?
  youtube    String?
  tiktok     String?
  bandcamp   String?
  soundcloud String?
  website    String?

  externalLink        String? // Keeping for backward compatibility or general link
  isVerifiedOrganizer Boolean @default(false)

  sentMessages     DirectMessage[] @relation("SentMessages")
  receivedMessages DirectMessage[] @relation("ReceivedMessages")
  uploadedMedia    Media[]         @relation("UploadedMedia")
  announcements    Announcement[]

  notifications     Notification[]  @relation("UserNotifications")
  sentNotifications Notification[]  @relation("NotificationActor")
  
  jamAttendance     JamAttendance[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Jam {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  description String?
  location    String?
  lat         Float?
  lng         Float?
  city        String?

  startTime DateTime?
  endTime   DateTime?
  flyerUrl  String?

  status    String  @default("SCHEDULED") // SCHEDULED, ACTIVE, FINISHED
  isPrivate Boolean @default(false)
  hostId    String
  host      User    @relation(fields: [hostId], references: [id], onDelete: Cascade)

  // Venue relation (optional, fallback to location string)
  venue     Venue?  @relation("VenueJams", fields: [venueId], references: [id])
  venueId   String?

  themes    Theme[]
  messages  Message[]
  media     Media[] @relation("JamMedia")
  attendance JamAttendance[] // Musicians checked in
  
  // Opening show info
  openingBand   String?
  openingInfo   String? 
  openingThemes String? 

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Theme {
  id            String  @id @default(cuid())
  name          String
  tonality      String?
  description   String?
  sheetMusicUrl String?
  status        String  @default("OPEN") // OPEN, QUEUED, PLAYING, FINISHED
  visibility    String  @default("PUBLIC") // PUBLIC, PRIVATE
  type          String  @default("SONG") // SONG, TOPIC

  jamId String
  jam   Jam    @relation(fields: [jamId], references: [id], onDelete: Cascade)

  participations Participation[]
  messages       Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Participation {
  id         String @id @default(cuid())
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  themeId    String
  theme      Theme  @relation(fields: [themeId], references: [id])
  instrument String
  status     String @default("WAITING") // WAITING, SELECTED

  createdAt DateTime @default(now())

  @@unique([userId, themeId])
}

model Message {
  id      String  @id @default(cuid())
  content String
  userId  String
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  jamId   String
  jam     Jam     @relation(fields: [jamId], references: [id], onDelete: Cascade)
  themeId String?
  theme   Theme?  @relation(fields: [themeId], references: [id])

  createdAt DateTime @default(now())
}

model DirectMessage {
  id         String @id @default(cuid())
  content    String
  senderId   String
  sender     User   @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User   @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  read      Boolean  @default(false)
}

model Venue {
  id          String   @id @default(cuid())
  name        String   @unique
  address     String?
  city        String?
  lat         Float?
  lng         Float?
  usageCount  Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  jams        Jam[]    @relation("VenueJams")
}

model Media {
  id           String    @id @default(cuid())
  type         MediaType
  url          String
  thumbnailUrl String?
  caption      String?
  uploadedBy   User      @relation("UploadedMedia", fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  jam          Jam       @relation("JamMedia", fields: [jamId], references: [id], onDelete: Cascade)
  jamId        String
  createdAt    DateTime  @default(now())
}

enum MediaType {
  PHOTO
  VIDEO
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String
  tag       String?  // Ej. Anuncio, Tutorial, Comunidad
  tagColor  String?  // Clases CSS: bg-jazz-gold/20 text-jazz-gold
  link      String?
  imageUrl  String?
  active    Boolean  @default(true)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // MENTION, SYSTEM, REPLY
  read      Boolean  @default(false)
  
  // Content
  message   String?
  link      String?  // URL to redirect to

  // Relationships
  userId    String   // Recipient
  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  actorId   String?  // Sender (optional)
  actor     User?    @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
}

model JamAttendance {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jamId      String
  jam        Jam      @relation(fields: [jamId], references: [id], onDelete: Cascade)
  instrument String?  // Instrument played in this specific jam

  joinedAt   DateTime @default(now())

  @@unique([userId, jamId]) // One check-in per user per jam
}
